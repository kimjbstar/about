<!DOCTYPE html><html lang="en"><title>Next.JS + TailwindCSS</title><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="icon" href="/favicon.ico"/><link rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/_next/static/css/602c9aeee430ea41.css" as="style"/><link rel="stylesheet" href="/_next/static/css/602c9aeee430ea41.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-38cee4c0e358b1a3.js" defer=""></script><script src="/_next/static/chunks/framework-73b8966a3c579ab0.js" defer=""></script><script src="/_next/static/chunks/main-38ead3c0359836e3.js" defer=""></script><script src="/_next/static/chunks/pages/_app-8da71599b066680e.js" defer=""></script><script src="/_next/static/chunks/0f4ba5df-f4fef96fbe8038cd.js" defer=""></script><script src="/_next/static/chunks/664-71f85c7425211588.js" defer=""></script><script src="/_next/static/chunks/556-974ba8e86a8c1b84.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bid%5D-93c70fb44ca1f648.js" defer=""></script><script src="/_next/static/sDNbZE89o9LIbwiabTfny/_buildManifest.js" defer=""></script><script src="/_next/static/sDNbZE89o9LIbwiabTfny/_ssgManifest.js" defer=""></script></head><body><div id="__next"><main class="__className_f62174"><nav class="text-s flex justify-center border-b-2 border-gray-100"><div class="flex justify-around max-w-[1200px] w-full"><div class="p-6"><a href="/about">About</a></div><div class="p-6"><a href="/blog">Blog</a></div><div class="p-6"><a href="/other">Other</a></div></div></nav><section class="flex flex-col items-center mt-20"><div class="max-w-7xl flex flex-col"><div class="text-6xl mb-10 font-bold text-gray-800">sequelize-typescript-migration 라이브러리 npm 배포</div><div class="text-4xl mb-10 text-gray-700"></div><div class="self-end">2020-06-15T08:36:34+00:00</div><div class="markdown-body"><h1>서론</h1>
<p>퇴사 후 nBase 프로젝트 진행 중, 초반에는 ORM을 sequelize로 사용하고 있었습니다. sequelize 라이브러리는 다 만족했으나 공식적으로 타입 및 데코레이터 지원을 하지 않았습니다. 그리하여 비공식 라이브러리인 sequelize-typescript를 사용하였고 조금 찝찝했지만 큰 문제 없이 사용하고 있었습니다.</p>
<p><a href="https://www.npmjs.com/package/sequelize-typescript">sequelize-typescript</a></p>
<h1>이슈</h1>
<p>개발을 진행함에 따라 스키마 형상 관리를 하는 migration이란 기능을 사용하려고 했습니다. 제가 원하는 migration은 단순히 migration 파일을 작성 후 적용이 아니라, django에서 제공하는 makemigrations 처럼 migration 파일을 generate해주는 기능을 원했습니다. 즉, 코드에 model로 정의된 스키마와 실제 DB에 생성되어 있는 스키마를 비교하여 그 차이를 기반으로 쿼리를 만들어 up, down function을 자동으로 생성시켜 주는 기능입니다. 이 기능이 없다면 개발자가 변경 시 마다 직접 모델과 DB를 비교하여 ALTER TABLE 쿼리 등을 작성해주어야 합니다.</p>
<p><a href="https://docs.djangoproject.com/en/3.0/ref/django-admin/#django-admin-makemigrations">django-admin and manage.py | Django documentation | Django</a></p>
<p>하지만 문제가 두 가지 있었습니다.</p>
<ul>
<li>js 기반의 sequelize는 일단 공식적으로 migration이 지원됩니다. 하지만 아쉽게도 <strong>migration file generator는 없었습니다.</strong></li>
<li>그래도 찾아보니 비공식 라이브러리는 있었습니다. <strong>하지만 현재 버전과는 맞지 않고, typescript 기반에서 동작하지 않습니다.</strong></li>
</ul>
<p>우선 위에 해당하는 라이브러리인 sequelize-auto-migrations을 살펴보았습니다.</p>
<p><a href="https://github.com/flexxnn/sequelize-auto-migrations">flexxnn/sequelize-auto-migrations</a></p>
<p>로직을 요약하면 sequelize에 있는 models object array를 파싱하여 tables data를 얻고 이전의 tables data와 비교하여 쿼리를 생성합니다. 그리고 sequelize 기준으로 sync된 마지막 버전의 tables data를 새로운 table에 저장하여 관리하는 방식입니다.</p>
<p>로직 상의 큰 변화는 없고, typescript를 사용하여 생산성 증가, 리팩토링, 함수 리네이밍 및 모듈화 등으로 코드를 좀 더 견고하게 만들었습니다. 가장 큰 차이점은 <strong>sequelize 라이브러리 대신 sequelize-typescript 라이브러리를 사용</strong>하여 데코레이터 등을 통해 정의한 Column 정보들을 가지고 올 수 있게 되었다는 점이었습니다.</p>
<p><img src="https://pihxnuyialxsmkzxlpjj.supabase.co/storage/v1/object/public/bucket01/stm01.png" alt=""/>
<img src="https://pihxnuyialxsmkzxlpjj.supabase.co/storage/v1/object/public/bucket01/stm02.png" alt=""/>
<img src="https://pihxnuyialxsmkzxlpjj.supabase.co/storage/v1/object/public/bucket01/stm03.png" alt=""/>
<img src="https://pihxnuyialxsmkzxlpjj.supabase.co/storage/v1/object/public/bucket01/stm04.png" alt=""/></p>
<h1>npm 배포</h1>
<p>처음에는 프로젝트 내에 프로젝트를 만들어 관리하려 했으나, 그렇게 할 경우 새로운 프로젝트를 들어갔을 때 import 하는 과정에서 이슈가 생길 것으로 보여 npm 에 배포하여 install 하는 방식으로 구상했다. npm publish 과정에 대한 것은 아래 두 글을 많이 참고했습니다.</p>
<p><a href="https://heropy.blog/2019/01/31/node-js-npm-module-publish/">내 NPM 패키지(모듈) 배포하기</a></p>
<p><a href="https://blog.ull.im/engineering/2018/12/23/how-to-create-and-publish-npm-module-in-typescript.html">[번역] TypeScript로 NPM 모듈을 만들어 배포하기</a></p>
<p>그리하여 package.json을 다음과 같이 구성하고 npm 에 가입 및 첫 배포를 완료했습니다!</p>
<p><img src="https://pihxnuyialxsmkzxlpjj.supabase.co/storage/v1/object/public/bucket01/stm05.png" alt=""/></p>
<p><img src="https://pihxnuyialxsmkzxlpjj.supabase.co/storage/v1/object/public/bucket01/stm06.png" alt=""/></p>
<p><a href="https://www.npmjs.com/package/sequelize-typescript-migration">sequelize-typescript-migration</a></p>
<h1>결론</h1>
<p>사실 오픈소스로 배포하기에는 퀄리티가 조악하여 꺼려졌으나, 폐쇄적으로 배포할 공간도 마땅하지 않고, 따지고 보면 저도 기존 라이브러리를 검색하여 도움을 받았으니 이 라이브러리도 누군가에겐 도움이 되지 않을까 생각하여 배포하였습니다. 결과적으로 npm에 소스를 배포한다는 것에 대한 전반적인 과정을 살펴볼 수 있었고, package.json의 각 key의 역할을 한 번 더 자세히 공부해 볼 수 있는 좋은 기회였습니다.</p></div></div></section></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"blog":{"id":"ab8aa268-c4bc-41d7-82d4-49b3e39b8d1e","title":"sequelize-typescript-migration 라이브러리 npm 배포","content":"# 서론\n\n퇴사 후 nBase 프로젝트 진행 중, 초반에는 ORM을 sequelize로 사용하고 있었습니다. sequelize 라이브러리는 다 만족했으나 공식적으로 타입 및 데코레이터 지원을 하지 않았습니다. 그리하여 비공식 라이브러리인 sequelize-typescript를 사용하였고 조금 찝찝했지만 큰 문제 없이 사용하고 있었습니다.\n\n[sequelize-typescript](https://www.npmjs.com/package/sequelize-typescript)\n\n# 이슈\n\n개발을 진행함에 따라 스키마 형상 관리를 하는 migration이란 기능을 사용하려고 했습니다. 제가 원하는 migration은 단순히 migration 파일을 작성 후 적용이 아니라, django에서 제공하는 makemigrations 처럼 migration 파일을 generate해주는 기능을 원했습니다. 즉, 코드에 model로 정의된 스키마와 실제 DB에 생성되어 있는 스키마를 비교하여 그 차이를 기반으로 쿼리를 만들어 up, down function을 자동으로 생성시켜 주는 기능입니다. 이 기능이 없다면 개발자가 변경 시 마다 직접 모델과 DB를 비교하여 ALTER TABLE 쿼리 등을 작성해주어야 합니다.\n\n[django-admin and manage.py | Django documentation | Django](https://docs.djangoproject.com/en/3.0/ref/django-admin/#django-admin-makemigrations)\n\n하지만 문제가 두 가지 있었습니다.\n\n- js 기반의 sequelize는 일단 공식적으로 migration이 지원됩니다. 하지만 아쉽게도 **migration file generator는 없었습니다.**\n- 그래도 찾아보니 비공식 라이브러리는 있었습니다. **하지만 현재 버전과는 맞지 않고, typescript 기반에서 동작하지 않습니다.**\n\n우선 위에 해당하는 라이브러리인 sequelize-auto-migrations을 살펴보았습니다. \n\n[flexxnn/sequelize-auto-migrations](https://github.com/flexxnn/sequelize-auto-migrations)\n\n로직을 요약하면 sequelize에 있는 models object array를 파싱하여 tables data를 얻고 이전의 tables data와 비교하여 쿼리를 생성합니다. 그리고 sequelize 기준으로 sync된 마지막 버전의 tables data를 새로운 table에 저장하여 관리하는 방식입니다.\n\n로직 상의 큰 변화는 없고, typescript를 사용하여 생산성 증가, 리팩토링, 함수 리네이밍 및 모듈화 등으로 코드를 좀 더 견고하게 만들었습니다. 가장 큰 차이점은 **sequelize 라이브러리 대신 sequelize-typescript 라이브러리를 사용**하여 데코레이터 등을 통해 정의한 Column 정보들을 가지고 올 수 있게 되었다는 점이었습니다.\n\n![](https://pihxnuyialxsmkzxlpjj.supabase.co/storage/v1/object/public/bucket01/stm01.png)\n![](https://pihxnuyialxsmkzxlpjj.supabase.co/storage/v1/object/public/bucket01/stm02.png)\n![](https://pihxnuyialxsmkzxlpjj.supabase.co/storage/v1/object/public/bucket01/stm03.png)\n![](https://pihxnuyialxsmkzxlpjj.supabase.co/storage/v1/object/public/bucket01/stm04.png)\n\n# npm 배포\n\n처음에는 프로젝트 내에 프로젝트를 만들어 관리하려 했으나, 그렇게 할 경우 새로운 프로젝트를 들어갔을 때 import 하는 과정에서 이슈가 생길 것으로 보여 npm 에 배포하여 install 하는 방식으로 구상했다. npm publish 과정에 대한 것은 아래 두 글을 많이 참고했습니다.\n\n[내 NPM 패키지(모듈) 배포하기](https://heropy.blog/2019/01/31/node-js-npm-module-publish/)\n\n[[번역] TypeScript로 NPM 모듈을 만들어 배포하기](https://blog.ull.im/engineering/2018/12/23/how-to-create-and-publish-npm-module-in-typescript.html)\n\n그리하여 package.json을 다음과 같이 구성하고 npm 에 가입 및 첫 배포를 완료했습니다!\n\n![](https://pihxnuyialxsmkzxlpjj.supabase.co/storage/v1/object/public/bucket01/stm05.png)\n\n![](https://pihxnuyialxsmkzxlpjj.supabase.co/storage/v1/object/public/bucket01/stm06.png)\n\n[sequelize-typescript-migration](https://www.npmjs.com/package/sequelize-typescript-migration)\n\n# 결론\n\n사실 오픈소스로 배포하기에는 퀄리티가 조악하여 꺼려졌으나, 폐쇄적으로 배포할 공간도 마땅하지 않고, 따지고 보면 저도 기존 라이브러리를 검색하여 도움을 받았으니 이 라이브러리도 누군가에겐 도움이 되지 않을까 생각하여 배포하였습니다. 결과적으로 npm에 소스를 배포한다는 것에 대한 전반적인 과정을 살펴볼 수 있었고, package.json의 각 key의 역할을 한 번 더 자세히 공부해 볼 수 있는 좋은 기회였습니다.","created_at":"2020-06-15T08:36:34+00:00","subtitle":null,"is_show":true}},"__N_SSG":true},"page":"/blog/[id]","query":{"id":"ab8aa268-c4bc-41d7-82d4-49b3e39b8d1e"},"buildId":"sDNbZE89o9LIbwiabTfny","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>